name: Validate models.csv

on:
  push:
    branches-ignore:
      - master
      - develop
  pull_request:
    branches-ignore:
      - master
      - develop

jobs:
  validate-csv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
    
    - name: Call CSV structure validation workflow
      uses: Open-Systems-Pharmacology/Workflows/.github/workflows/Check_CSV.yml@main
    
    - name: Validate models.csv
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        #!/bin/bash
        
        # Enable debugging and error propagation
        set -euo pipefail
        
        # Create a shared error file that persists across subshells
        ERROR_FILE="validation_errors.txt"
        touch "$ERROR_FILE"
        
        # Function to add error with proper locking
        add_error() {
            echo "$1" | tee -a "$ERROR_FILE"
            echo "ERROR: $1" >&2
        }
        
        # Function to log debug info
        log_debug() {
            echo "DEBUG: $1" >&2
        }
        
        # Function to make GitHub API calls with error handling
        github_api() {
            local url="$1"
            log_debug "Making API call to: $url"
            local response
            if ! response=$(curl -s -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
                          -H "Accept: application/vnd.github.v3+json" \
                          "$url" 2>&1); then
                log_debug "API call failed: $response"
                return 1
            fi
            
            local http_code="${response: -3}"
            local body="${response%???}"
            
            log_debug "HTTP Code: $http_code"
            
            if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
                echo "$body"
                return 0
            else
                log_debug "API error - HTTP $http_code: $body"
                return 1
            fi
        }
        
        # Function to check if URL is valid
        check_url() {
            local url="$1"
            log_debug "Checking URL: $url"
            if curl -s --head "$url" 2>/dev/null | head -n 1 | grep -q "200 OK"; then
                log_debug "URL is valid"
                return 0
            else
                log_debug "URL is invalid"
                return 1
            fi
        }
        
        echo "Starting validation of models.csv..."
        
        # Verify CSV file exists
        if [[ ! -f "models.csv" ]]; then
            add_error "models.csv file not found"
            exit 1
        fi
        
        log_debug "CSV file found, starting validation..."
        
        # Check 1: Empty lines or lines with only blanks
        echo "Check 1: Validating empty lines..."
        line_num=1
        while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ -z "${line// }" ]]; then
                add_error "Line $line_num is empty or contains only blanks"
            fi
            ((line_num++))
        done < models.csv
        
        log_debug "Check 1 completed"
        
        # Check 2: Execute column validation
        echo "Check 2: Validating Execute column..."
        
        # Read header to find Execute column
        header=$(head -n 1 models.csv)
        log_debug "CSV Header: $header"
        
        # Find Execute column index
        execute_col_index=0
        IFS=',' read -ra HEADER_FIELDS <<< "$header"
        for i in "${!HEADER_FIELDS[@]}"; do
            field=$(echo "${HEADER_FIELDS[$i]}" | sed 's/^"//; s/"$//' | tr -d '\r\n')
            if [[ "$field" == "Execute" ]]; then
                execute_col_index=$((i + 1))
                break
            fi
        done
        
        log_debug "Execute column index: $execute_col_index"
        
        if [[ $execute_col_index -eq 0 ]]; then
            add_error "Execute column not found in CSV header"
        else
            line_num=2
            while IFS= read -r line || [[ -n "$line" ]]; do
                if [[ -n "$line" ]]; then
                    execute_val=$(echo "$line" | cut -d',' -f"$execute_col_index" | sed 's/^"//; s/"$//' | tr -d '\r\n' | tr -d ' ')
                    if [[ "$execute_val" != "TRUE" && "$execute_val" != "FALSE" ]]; then
                        add_error "Line $line_num: Execute column value '$execute_val' is not TRUE or FALSE"
                    fi
                fi
                ((line_num++))
            done < <(tail -n +2 models.csv)
        fi
        
        log_debug "Check 2 completed"
        
        # Function to get column index
        get_column_index() {
            local column_name="$1"
            local index=0
            IFS=',' read -ra FIELDS <<< "$header"
            for i in "${!FIELDS[@]}"; do
                field=$(echo "${FIELDS[$i]}" | sed 's/^"//; s/"$//' | tr -d '\r\n')
                if [[ "$field" == "$column_name" ]]; then
                    echo $((i + 1))
                    return 0
                fi
            done
            echo 0
        }
        
        # Get column indices
        REPO_COL=$(get_column_index "Repository name")
        VERSION_COL=$(get_column_index "Released version")
        SNAPSHOT_COL=$(get_column_index "Snapshot name")
        WORKFLOW_COL=$(get_column_index "Workflow name")
        FOLDER_COL=$(get_column_index "Folder name")
        ADDITIONAL_COL=$(get_column_index "Additional projects")
        
        log_debug "Column indices - Repo: $REPO_COL, Version: $VERSION_COL, Snapshot: $SNAPSHOT_COL, Workflow: $WORKFLOW_COL, Folder: $FOLDER_COL, Additional: $ADDITIONAL_COL"
        
        # Function to extract CSV field
        extract_field() {
            local line="$1"
            local field_num="$2"
            if [[ $field_num -gt 0 ]]; then
                echo "$line" | cut -d',' -f"$field_num" | sed 's/^"//; s/"$//' | tr -d '\r\n'
            else
                echo ""
            fi
        }
        
        # Function to check if release exists
        check_release_exists() {
            local repo_name="$1"
            local version="$2"
            log_debug "Checking if release v$version exists for $repo_name"
            local response
            if response=$(github_api "https://api.github.com/repos/Open-Systems-Pharmacology/$repo_name/releases/tags/v$version"); then
                if echo "$response" | jq -e '.tag_name' >/dev/null 2>&1; then
                    log_debug "Release found"
                    return 0
                fi
            fi
            log_debug "Release not found"
            return 1
        }
        
        # Function to get latest release version
        get_latest_version() {
            local repo_name="$1"
            log_debug "Getting latest version for $repo_name"
            local response
            if response=$(github_api "https://api.github.com/repos/Open-Systems-Pharmacology/$repo_name/releases"); then
                local latest=$(echo "$response" | jq -r '.[0].tag_name // empty' 2>/dev/null | sed 's/^v//')
                log_debug "Latest version: $latest"
                echo "$latest"
            else
                log_debug "Could not get releases"
                echo ""
            fi
        }
        
        # Function to check if file exists in release
        check_file_in_release() {
            local repo_name="$1"
            local version="$2"
            local file_path="$3"
            local case_insensitive="$4"
            
            log_debug "Checking file $file_path in $repo_name v$version (case_insensitive: $case_insensitive)"
            
            # First try exact match
            local response
            if response=$(github_api "https://api.github.com/repos/Open-Systems-Pharmacology/$repo_name/contents/$file_path?ref=v$version"); then
                if echo "$response" | jq -e '.name' >/dev/null 2>&1; then
                    log_debug "File found (exact match)"
                    return 0
                fi
            fi
            
            # If case insensitive and exact match failed, try directory listing
            if [[ "$case_insensitive" == "true" ]]; then
                log_debug "Trying case-insensitive search"
                local dir_path=$(dirname "$file_path")
                local file_name=$(basename "$file_path")
                
                local dir_response
                if [[ "$dir_path" == "." ]]; then
                    dir_response=$(github_api "https://api.github.com/repos/Open-Systems-Pharmacology/$repo_name/contents?ref=v$version")
                else
                    dir_response=$(github_api "https://api.github.com/repos/Open-Systems-Pharmacology/$repo_name/contents/$dir_path?ref=v$version")
                fi
                
                if [[ -n "$dir_response" ]] && echo "$dir_response" | jq -e '.[]' >/dev/null 2>&1; then
                    local found=$(echo "$dir_response" | jq -r '.[].name' 2>/dev/null | grep -i "^${file_name}$" | head -n1)
                    if [[ -n "$found" ]]; then
                        log_debug "File found (case-insensitive match): $found"
                        return 0
                    fi
                fi
            fi
            
            log_debug "File not found"
            return 1
        }
        
        echo "Check 3: Validating releases and files..."
        
        # Process each row (skip header) - avoid subshells for error propagation
        row_count=$(tail -n +2 models.csv | wc -l)
        log_debug "Processing $row_count rows"
        
        current_row=0
        while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ -n "$line" ]]; then
                ((current_row++))
                line_num=$((current_row + 1))
                log_debug "Processing row $current_row (line $line_num): $line"
                
                repo_name=$(extract_field "$line" "$REPO_COL")
                version=$(extract_field "$line" "$VERSION_COL")
                snapshot_name=$(extract_field "$line" "$SNAPSHOT_COL")
                workflow_name=$(extract_field "$line" "$WORKFLOW_COL")
                
                log_debug "Extracted - Repo: '$repo_name', Version: '$version', Snapshot: '$snapshot_name', Workflow: '$workflow_name'"
                
                if [[ -z "$repo_name" || -z "$version" ]]; then
                    log_debug "Skipping row due to missing repo name or version"
                    continue
                fi
                
                # Check 3a: Release exists
                if ! check_release_exists "$repo_name" "$version"; then
                    add_error "There is no release $version in $repo_name"
                    continue
                fi
                
                # Check 3b: Latest release
                latest_version=$(get_latest_version "$repo_name")
                if [[ -n "$latest_version" && "$latest_version" != "$version" ]]; then
                    add_error "$version has the newest release $latest_version"
                fi
                
                # Check 3c: Snapshot file
                if [[ -n "$snapshot_name" ]]; then
                    if ! check_file_in_release "$repo_name" "$version" "$snapshot_name.json" "false"; then
                        add_error "Snapshot name $snapshot_name is invalid for $repo_name"
                    fi
                fi
                
                # Check 3d & 3e: Workflow files
                if [[ -z "$workflow_name" ]]; then
                    # Check default workflow
                    if ! check_file_in_release "$repo_name" "$version" "Evaluation/workflow.R" "true"; then
                        add_error "The default workflow file Evaluation/workflow.R not found for $repo_name"
                    fi
                else
                    # Check specified workflow
                    if ! check_file_in_release "$repo_name" "$version" "$workflow_name" "true"; then
                        add_error "The workflow file $workflow_name not found for $repo_name"
                    fi
                fi
            fi
        done < <(tail -n +2 models.csv)
        
        log_debug "Check 3 completed"
        
        echo "Check 4: Validating folders..."
        
        # Get folders from develop branch
        log_debug "Getting folders from develop branch"
        develop_response=$(github_api "https://api.github.com/repos/Open-Systems-Pharmacology/OSP-PBPK-Model-Library/contents?ref=develop")
        
        if [[ -z "$develop_response" ]]; then
            add_error "Could not fetch folders from OSP-PBPK-Model-Library develop branch"
        else
            log_debug "Develop branch response received"
            
            # Extract folder names
            develop_folders=$(echo "$develop_response" | jq -r '.[] | select(.type == "dir") | .name' 2>/dev/null || echo "")
            log_debug "Develop folders: $develop_folders"
            
            # Get folders from CSV - avoid subshells
            csv_folders_file=$(mktemp)
            while IFS= read -r line || [[ -n "$line" ]]; do
                if [[ -n "$line" ]]; then
                    folder_name=$(extract_field "$line" "$FOLDER_COL")
                    if [[ -n "$folder_name" ]]; then
                        echo "$folder_name" >> "$csv_folders_file"
                    fi
                fi
            done < <(tail -n +2 models.csv)
            
            # Check each develop folder exists in CSV
            while IFS= read -r folder; do
                if [[ -n "$folder" ]]; then
                    log_debug "Checking if folder '$folder' exists in CSV"
                    if ! grep -q "^${folder}$" "$csv_folders_file"; then
                        add_error "Folder $folder is not found"
                    fi
                fi
            done <<< "$develop_folders"
            
            rm -f "$csv_folders_file"
        fi
        
        log_debug "Check 4 completed"
        
        echo "Check 5: Validating additional projects..."
        
        # Process additional projects - avoid subshells
        while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ -n "$line" ]]; then
                additional_projects=$(extract_field "$line" "$ADDITIONAL_COL")
                log_debug "Processing additional projects: '$additional_projects'"
                
                if [[ -n "$additional_projects" ]]; then
                    # Split by pipe and process each project
                    IFS='|' read -ra PROJECTS <<< "$additional_projects"
                    for project in "${PROJECTS[@]}"; do
                        project=$(echo "$project" | xargs)  # trim whitespace
                        if [[ -n "$project" ]]; then
                            log_debug "Validating additional project: '$project'"
                            
                            # Check 5a: URL validation
                            url="https://raw.githubusercontent.com/Open-Systems-Pharmacology/$project"
                            if ! check_url "$url"; then
                                add_error "URL $url is not valid for additional project $project"
                            fi
                            
                            # Check 5b: Latest release validation
                            repo_name=$(echo "$project" | cut -d'/' -f1)
                            branch_name=$(echo "$project" | cut -d'/' -f2)
                            version=$(echo "$branch_name" | sed 's/^v//')
                            
                            log_debug "Additional project - Repo: '$repo_name', Version: '$version'"
                            
                            if [[ -n "$repo_name" && -n "$version" ]]; then
                                latest_version=$(get_latest_version "$repo_name")
                                if [[ -n "$latest_version" && "$latest_version" != "$version" ]]; then
                                    add_error "Additional project $project has the newest release $latest_version"
                                fi
                            fi
                        fi
                    done
                fi
            fi
        done < <(tail -n +2 models.csv)
        
        log_debug "Check 5 completed"
        
        # Display results
        echo "Validation completed."
        
        error_count=$(wc -l < "$ERROR_FILE" 2>/dev/null || echo 0)
        
        if [[ $error_count -gt 0 ]]; then
            echo "Validation errors found:"
            while IFS= read -r error; do
                echo "❌ $error"
            done < "$ERROR_FILE"
            echo ""
            echo "Total errors: $error_count"
            rm -f "$ERROR_FILE"
            exit 1
        else
            echo "✅ All validations passed!"
            rm -f "$ERROR_FILE"
        fi
